name: build

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # hourly; adjust if you want
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TZ: America/Chicago
      # keep one canonical path and reuse it for both fetch + transform
      INBOX_CSV: data/inbox/latest.csv
      JSON_OUT: events.json
      SHOW_SAMPLES: "true"
      FORCE_ALL: "true"     # accept all AC rows even if names are odd

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: |
          npm i
          # ensure these are present (idempotent if already in package.json)
          npm i imapflow mailparser --save

      - name: Ensure inbox dir
        run: mkdir -p data/inbox

      - name: Fetch newest email CSV -> data/inbox/latest.csv
        env:
          IMAP_HOST: imap.gmail.com
          IMAP_USER: ${{ secrets.IMAP_USER }}
          IMAP_PASS: ${{ secrets.IMAP_PASS }}
          OUT_CSV:   ${{ env.INBOX_CSV }}
        run: node scripts/fetch_email.js

      - name: Transform CSV -> events.json
        env:
          CSV_PATH:  ${{ env.INBOX_CSV }}
          JSON_OUT:  ${{ env.JSON_OUT }}
          TZ:        ${{ env.TZ }}
          SHOW_SAMPLES: ${{ env.SHOW_SAMPLES }}
          FORCE_ALL: ${{ env.FORCE_ALL }}
        run: node scripts/transform.mjs

      - name: Peek at events.json (first ~120 lines)
        run: |
          echo "Top of events.json:"
          sed -n '1,120p' events.json || true

      - name: Commit & push events.json (if changed)
        run: |
          git config user.name  "auto-bot"
          git config user.email "actions@users.noreply.github.com"
          git add events.json
          git commit -m "Update events.json" || echo "No changes"
          git push

# .github/workflows/build.yml
name: build
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"  # every 30 mins; adjust if you like

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Use npm i since there's no package-lock.json
      - name: Install deps
        run: npm i

      - name: Ensure inbox folder
        run: mkdir -p data/inbox

      # Your IMAP fetch step (if you have one). If not, keep the CSV upload path you already use.
      # - name: Fetch latest CSV via IMAP
      #   run: node scripts/fetch-imap.mjs

      - name: Transform CSV -> events.json
        env:
          CSV_PATH: data/inbox/latest.csv
          JSON_OUT: events.json           # write to repo root for Pages
          FORCE_ALL: "true"               # temporary: donâ€™t filter AC site
        run: node scripts/transform.mjs

      - name: Show summary
        run: |
          echo "Top of events.json:"
          head -n 40 events.json || true

      - name: Commit and push events.json
        run: |
          git config user.name  "auto-bot"
          git config user.email "auto-bot@users.noreply.github.com"
          git add -A
          git commit -m "Publish events.json [skip ci]" || echo "No changes"
          git push

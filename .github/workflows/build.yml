name: build

on:
  workflow_dispatch:
  schedule:
    # Runs hourly to pick up new reports; adjust as you like
    - cron: "0 * * * *"
  push:
    branches: [ main ]

permissions:
  contents: write   # needed so we can commit updated events.json

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TZ: America/Chicago           # show times in local facility TZ
      CSV_PATH: data/inbox/latest.csv
      JSON_OUT: events.json
      # Optional: show sample header values in logs for debugging
      SHOW_SAMPLES: "true"
      # Optional: accept all AC rows even if facility naming is odd
      FORCE_ALL: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps (use npm i to avoid the npm ci lockfile warning)
        run: npm i

      - name: Ensure inbox directory
        run: mkdir -p data/inbox

      # ⬇️ Put the inbox fetch step back in
      - name: Fetch latest CSV from Gmail
        run: node scripts/fetch-inbox.mjs
        env:
          IMAP_HOST: imap.gmail.com
          IMAP_USER: ${{ secrets.IMAP_USER }}
          IMAP_PASS: ${{ secrets.IMAP_PASS }}

      - name: Transform CSV -> events.json
        run: node scripts/transform.mjs

      - name: Show top of events.json for sanity
        run: |
          echo "Top of events.json:"
          head -n 80 events.json

      - name: Commit & push changes (events.json)
        run: |
          git config user.name "auto-bot"
          git config user.email "actions@users.noreply.github.com"
          git add -A
          git commit -m "Update events.json" || echo "No changes"
          git push

name: build

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"  # optional: refresh every 30 minutes

# ðŸ‘‡ allow the GITHUB_TOKEN to push commits
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # uses GITHUB_TOKEN

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm i

      - name: Ensure inbox dir
        run: mkdir -p data/inbox

      # Optional: fetch latest CSV from the Gmail account (requires secrets set)
      - name: Fetch latest CSV from email
        env:
          IMAP_USER: "raecroominfo.board@gmail.com"
          IMAP_PASS: ${{ secrets.GMAILIMAP }}  # your 16-char app password in repo secrets
        run: node scripts/fetch_email.js

      - name: Transform CSV -> events.json
        # If you sometimes want to bypass site filter, append 'FORCE_ALL=true'
        run: node scripts/transform.mjs

      - name: Show top of events.json (debug)
        run: |
          echo "Top of events.json:"
          head -n 60 events.json || true

      - name: Commit & push events.json
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add events.json
          git diff --quiet --cached && echo "No changes" && exit 0
          git commit -m "Update events.json [skip ci]"
          git push
